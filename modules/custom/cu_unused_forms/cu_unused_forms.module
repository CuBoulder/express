<?php


function cu_unused_forms_menu() {
  $items = array();
  $items['admin/reports/forms/unused'] = array(
    'title' => 'Unused Forms',
    'description' => 'A list of Forms that are not being displayed on this site.',
    'page callback' => 'cu_unused_forms_list',
    'access arguments' => array('view bean page'),
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function cu_unused_forms_permission() {
  return array(
    'view unused forms' => array(
      'title' => 'View Unused forms',
      'description' => 'View a list of unused/unreferenced forms.',
    ),
  );
}

function cu_unused_forms_list() {
  global $base_url;
  $output = '';
  $forms_count_query = db_query('SELECT * FROM webform');
  $forms_submissions_query = db_query('SELECT * FROM webform_submissions');

  $forms_count = $forms_count_query->fetchAll();
  $forms_submissions = $forms_submissions_query->fetchAll();

  $output .= '<h2>' . t('Your site currently has ') . count($forms_count) . t(' form(s).') . '</h2>';

  foreach ($forms_count as $form) {
    $nids[] = $form->nid;
  }
  foreach ($forms_submissions as $sub) {
    $sub_nids[] = $sub->nid;
  }

  $no_subs = array_diff($nids, $sub_nids);

  $output .= '<hr><h3>Webform nodes with no submissions</h3>';
  if (count($no_subs) > 0) {
    $output .= '<ul>';

    foreach ($no_subs as $node) {
      $output .= '<li><a href="' . $base_url . '/node/' . $node . '">Node ' . $node . '</a></li>';
    }

    $output .= '</ul>';
  } else {
    $output .= '<p>No results found.</p>';
  }

  return $output;
}
